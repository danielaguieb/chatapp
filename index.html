<!doctype html>
<html>
<head>
	<title>Socket.IO chat</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="UTF-8">
	<!-- <link href="style.css" rel="stylesheet" type="text/css"> -->
	<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100;400&display=swap" rel="stylesheet">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Roboto Mono', monospace;
		}
		body {
      		max-width: 960px;
      		max-height: 100%;
      		min-height: 100%;
		}

		#content {
      		display:flex;
      		justify-content:center;
		}
		
		#chatWrap {
			flex-grow: 3;
			max-width: 100%;
			
			display: flex;
			flex-direction: column;
		}

		#messages {
	 		list-style-type: none;
	 		margin: 0;
	 		padding: 0;

	 		overflow: scroll;
	 	}

	 	#messages li {
	 		padding: 5px 10px;
	 		text-overflow: ellipsis;
			white-space: nowrap;
			-moz-white-space: nowrap;
			overflow: hidden;
	 	}

	 	#messages li:nth-child(odd) {
	 		background: #eee;
	 	}

		form {
			background: #000;
			padding: 3px;/*
		    position: fixed;
		    bottom: 0;*/
		    width: auto;
	  	}

	  	form input {
		  	border: 0;
		  	padding: 10px;
		  	width: 90%;
		  	margin-right: 0.5%;
		}

	  	form button {
		  	width: 9%;
		  	background: rgb(130, 224, 255);
		  	border: none;
		  	padding: 10px;
	 	}

		#usersWrap {
			flex-grow: 1;
		}
	</style>
</head>
<body>
	<div id="content">
		<div id="chatWrap">
			<ul id="messages"></ul>
			<form action="">
				<input id="m" autocomplete="off" /><button>Send</button>
			</form>
		</div>

		<div id="usersWrap">			
			<li>Wow thing</li>
			<li>Psycho</li>
			<li>Monster</li>
		</div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script>
		// Debugging
		let arst = console.log.bind(console);
		// let arst = function(){};

		$(function () {
			var socket = io();

			// setting user and socket id on client side for hopefully good reasons
			// TODO if you don't need socketID on the client side, maybe get rid of it
			var socketID = "";
			var myUserName = "User";
			socket.on('setUserID', (sock_id) => {
				socketID = sock_id;
				myUserName += socketID;
				arst("socketID is: " + socketID);
				arst("username is: " + myUserName);
			});


			// when submitting either it's a message or a command
			$('form').submit(function(e){
				e.preventDefault(); // prevents page reloading
				let msg = ($('#m').val());
				socket.emit('chat message', msg);
				$('#m').val('');
				return false;
			});

			socket.on('chat message', function(msg, clr){
				$('#messages').append($('<li>').text(msg).css("color", "#"+clr));
			});

			// empty userList and repopulate it
			socket.on('updateUserList', (users) => {
				$('#usersWrap').empty();
				for(let userID in users){
					arst("in updateUserList");
					arst(userID);
					arst(myUserName);
					if(users[userID][0] === myUserName){
						$('#usersWrap').append($('<li>)').text(users[userID][0]+" (You)"));
					}
					else {
						$('#usersWrap').append($('<li>)').text(users[userID][0]));
					}
				}
			});

			socket.on('updateUserName', (newName) => {
				myUserName = newName;
			});

			socket.on('updateMessageColor', (messages) => {
				arst(messages);
				$('#messages').empty();
				for(let i=0; i<messages.length; i++){
					let message = messages[i];
					arst(message.time+" "+message.user+": "+message.msg);
					arst(message.clr);
					$('#messages').append($('<li>').text(message.time+" "+message.user+": "+message.msg).css("color", "#"+message.clr));
				}
			});
		});
	</script>
</body>
</html>